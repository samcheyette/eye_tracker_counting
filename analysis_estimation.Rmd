

---
output:
  html_document: default
  pdf_document:
    fig_caption: yes
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width=5, fig.height=5,fig.align = "center",cache=TRUE)
```


```{r, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE}
##libraries, globals

library(ggplot2)
library(reshape)
library(grid)
library(dplyr)
library(gridExtra)
library(lme4)
library(summarytools)

paper_theme <- theme(
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(), 
  panel.background = element_blank(),
  axis.title.x = element_text(size=18),
  axis.text.x=element_text(colour="black", 
                           size = 14), 
  axis.title.y = element_text(size = 18, vjust = 1),
  axis.text.y  = element_text(size = 14),
  axis.line.x = element_line(colour = "black"), 
  axis.line.y = element_line(colour = "black"),
  legend.text=element_text(size=16),
  strip.text=element_blank(),
          strip.background = element_blank())

paper_theme_2 <- theme_light() + theme(axis.title.x = element_text(size=18),
  axis.text.x=element_text(colour="black", 
                           size = 14), 
  axis.title.y = element_text(size = 18, vjust = 1),
  axis.text.y  = element_text(size = 14))

paper_theme_3 <- theme( axis.title.x = element_text(size=18),
  axis.text.x=element_text(colour="black", 
                           size = 14), 
  axis.title.y = element_text(size = 18, vjust = 1),
  axis.text.y  = element_text(size = 14),
  strip.text=element_text(size=16),
  axis.line.x = element_line(colour = "black"), 
  axis.line.y = element_line(colour = "black"),
  legend.title=element_text(size=18),
  legend.text=element_text(size=16))  


binomial_smooth <- function(...) {
  geom_smooth(method = "glm", method.args = list(family = "binomial"), ...)
}
```


```{r, include=FALSE, echo=FALSE, warning=FALSE,message=FALSE}

data.resp.loc <- read.csv("data/estimation_dot_gaze.csv", sep="\t")
data.tracker <- read.csv("data/estimation_tracker_data.csv", sep="\t")
data.tracker$trial_id <- data.tracker$trial_id - 1
data.resp.loc$trial_id <- data.resp.loc$trial_id - 1


data.resp.loc <- data.resp.loc %>%
                filter(belowX >= 0)

trials <- (unique(data.resp.loc$trial_id))

data.tracker <- data.tracker %>%
                group_by(trial_id) %>%
                filter(trial_id %in% trials)


data.resp.loc$id <- seq.int(1, nrow(data.resp.loc))


data.resp <- data.resp.loc %>%
            group_by(Trial, Time, pid) %>%
            top_n(n=1, wt=id) %>%
            group_by(Dots_Counted, Dots_Shown, pid) %>%
            mutate(err=Dots_Counted - Dots_Shown) %>%
            mutate(abs_err = abs(err)) %>%
            mutate(over = 1*(Dots_Counted > Dots_Shown)) %>%
            mutate(under = 1*(Dots_Shown > Dots_Counted)) %>%
            mutate(corr= 1*(Dots_Counted == Dots_Shown)) %>%
            filter(Dots_Counted < 201)


data.tracker <- data.tracker %>%
                  filter(ValidityLeft == 0 & ValidityRight == 0) %>%

                mutate(av_x = (GazePointXLeft +GazePointXRight)/2) %>%
                mutate(av_y = (GazePointYLeft +GazePointYRight)/2) %>%
                group_by(trial_id) %>%
                mutate(Time = round(max(TimeStamp)/100)/10)

data.tracker$id <- seq.int(1,nrow(data.tracker))






```


```{r}

data.resp$Time <- as.factor(round(data.resp$Time,2))

ggplot(data=data.resp, aes(x=Dots_Shown, y=Dots_Counted)) +
       geom_point(alpha=0.5)  +
        #stat_summary_bin(fun.data="mean_cl_boot", bins=10) +
        stat_smooth(method="loess") +
        geom_abline() +
        xlab("Number of dots") +
        ylab("Estimated number") +
        theme_light() + paper_theme_3 

ggplot(data=data.resp, aes(x=Dots_Shown, y=Dots_Counted, group=Time, color=Time)) +
       #geom_point(alpha=0.5)  +
        stat_summary_bin(fun.data="mean_cl_boot", bins=4, span=3) +
        stat_smooth(method="lm", se=FALSE) +
        coord_cartesian(ylim=c(0,80)) +
        geom_abline() +
        xlab("Number of dots") +
        ylab("Estimated number") +
        theme_light() + paper_theme_3 



ggplot(data=data.resp, aes(x=Dots_Shown, y=Dots_Counted, group=Time, color=Time)) +
       #geom_point(alpha=0.5)  +
       stat_summary_bin(fun.data="mean_cl_boot", bins=10, geom="point", position=position_dodge(width=7),size=1.25) +
       stat_summary_bin(fun.data="mean_cl_boot", bins=10, geom="errorbar",size=1.5,width=0.25,alpha=0.5, position=position_dodge(width=7)) +

        #stat_smooth(method="loess", se=TRUE, span=1.5) +
        geom_abline() +
        xlab("Number of dots") +
        ylab("Estimated number") +
        theme_light() + paper_theme_3 
        
```

```{r, fig.width=7.5, fig.height=5, results='asis', message=FALSE, echo=FALSE, warning=FALSE}


  data.resp.avs <- data.resp.loc %>%
                  filter(gazeDist > 0 & Dots_Shown < 150 & Dots_Shown >= 10) %>%
                  mutate(err=Dots_Counted - Dots_Shown) %>%
                  mutate(abs_err = abs(err)) %>%
                  #mutate(within_x = (gazeDist < 100)*1) %>%
                  #mutate(within_x = 1.*(belowX > 1) + 0.5 * (belowX > 3) + 0.2 * (belowX > 6) + 0.25 * (belowX > 10)) %>%
                  mutate(within_x = 2/(1 + exp(-0.6 -0.2*belowX)) - 1) %>%
                  #mutate(within_x = 1 * (belowX > 4)) %>% 
                  group_by(trial_id) %>% 
                  mutate(belowX = mean(belowX)) %>%
                  mutate(within_x = mean(within_x)) %>%
                  mutate(within_x_tot = sum(within_x)) %>%

                  mutate(mean_dist=sum(gazeDist)/Dots_Shown) %>%
                  mutate(mean_abs_err = mean(abs_err)) %>%
                  mutate(pct_err=err/Dots_Shown) %>%
                    mutate(abs_pct_err=abs_err/Dots_Shown) %>%

                  top_n(n=1, wt=id) %>% 
                  #filter(mean_dist < 600) %>%
                  filter(abs_pct_err < 1.0) 



```


```{r, fig.width=7.5, fig.height=5, results='asis', message=FALSE, echo=FALSE, warning=FALSE}

#summary(lmer(data=data.resp.avs, pct_err ~ belowX + Time + (1|pid)))
#summary(lm(data=data.resp.avs, pct_err ~  I(log(belowX)) * Time))
#summary(lm(data=data.resp.avs, pct_err ~  belowX * Time))
summary(lm(data=data.resp.avs, abs_err ~  within_x + Dots_Shown))

summary(lm(data=data.resp.avs, pct_err ~  within_x + Dots_Shown + within_x_tot))

summary(lm(data=data.resp.avs, pct_err ~  within_x * Dots_Shown))
summary(lm(data=data.resp.avs, abs_err ~  within_x_tot * Dots_Shown))
summary(lm(data=data.resp.avs, pct_err ~  within_x_tot * Dots_Shown))
summary(lm(data=data.resp.avs, Dots_Counted ~  within_x_tot ))

summary(lm(data=data.resp.avs, Dots_Counted ~  Dots_Shown))
summary(lm(data=data.resp.avs, Dots_Counted ~  within_x_tot + Dots_Shown))
summary(lm(data=data.resp.avs, abs_err ~  I(abs(within_x_tot - Dots_Shown))))

#summary(lm(data=data.resp.avs, pct_err ~  within_x + Dots_Shown))
#summary(lm(data=data.resp.avs, abs_err ~  within_x + Dots_Shown ))

p.0 <- ggplot(data=data.resp.avs, aes(x=factor(Time), y=pct_err)) +
      stat_summary(fun.data="mean_cl_boot", geom="bar", color="gray", alpha=0.7) +
 stat_summary(fun.data="mean_cl_boot", geom="point", color="black") + 
      stat_summary(fun.data="mean_cl_boot", geom="errorbar", color="black", width=0) + 

        ylab("Mean percent error") +
        xlab("Time (s)") + paper_theme 
#ggsave("figs/time_effect.pdf", width=5, height=5)
#ggsave("figs/time_effect.png", width=5, height=5)

p.1 <- ggplot(data.resp.avs, aes(x=within_x, y=pct_err)) +
        #geom_point() +
        geom_point(aes(color=factor(Time))) +
        stat_smooth(method="lm", aes(color=factor(Time)), se=FALSE, span=1.25) +
        facet_wrap(~pid, scales="free_y") +
        xlab("P(dots within gaze)") +
        ylab("Abs Percent Error") +
          #xlim(0,0.75) +
          scale_x_log10() + 
         scale_color_discrete(name="Time") +
        theme_light() + 
        paper_theme_3
  
 #ggsave("figs/gaze_by_part_time.pdf", width=7,height=5)
 #ggsave("figs/gaze_by_part_time.png", width=7,height=5)


        

p.2 <- ggplot(data.resp.avs, aes(x=within_x, y=pct_err)) +
        geom_point() +
        #stat_summary_bin(bins=10, fun.data="mean_cl_boot") +
        stat_smooth(method="loess", se=FALSE, span=1.25) +
        facet_wrap(~pid, scales="free") +
        xlab("P(dots within gaze)") +
        ylab("Abs Percent Error") +
        #  xlim(0,0.75) + 
          scale_x_log10() +
      theme_light() + 
      paper_theme_3
  
#ggsave("figs/gaze_by_part.pdf", width=5,height=5)
#ggsave("figs/gaze_by_part.png", width=5,height=5)


p.3 <- ggplot(data.resp.avs, aes(x=within_x, y=abs_pct_err)) +
        geom_point(aes(color=factor(Time)), alpha=0.35, size=2.) +
        stat_smooth(method="loess", se=FALSE, aes(color=factor(Time)), span=3, size=1.5) +
        xlab("P(dots within gaze)") +
        ylab("Absolute percent error") +
        #xlim(0,0.75) +
           scale_color_discrete(name="Time") +
        theme_light() + scale_x_log10() +
        paper_theme_3 # + xlim(-4,0)

p.3.1 <- ggplot(data.resp.avs, aes(x=within_x, y=abs_pct_err)) +
        #geom_point(alpha=0.35, size=2.) +
          stat_summary_bin(fun.data="mean_cl_boot", bins=10 ) +

        stat_smooth(method="loess", se=TRUE,  span=3, size=1.5) +
        xlab("P(dots within gaze)") +
        ylab("Absolute percent error") +
        #xlim(0,0.75) +
           scale_color_discrete(name="Time") +
        theme_light()  +paper_theme_3 +
        scale_x_log10()

p.3.2 <- ggplot(data.resp.avs, aes(x=within_x, y=pct_err)) +
        #geom_point(alpha=0.35, size=2.) +
          stat_summary_bin(fun.data="mean_cl_boot", bins=13 ) +

        stat_smooth(method="loess", se=TRUE,  span=3, size=1.5) +
        xlab("P(dots within gaze)") +
        ylab("Percent error") +
        #xlim(0,0.75) +
           scale_color_discrete(name="Time") +
        theme_light()  +paper_theme_3 +
        scale_x_log10()
# ggsave("figs/gaze.pdf", width=5,height=5) 
        
# ggsave("figs/gaze.png", width=5,height=5)


 p.4 <- ggplot(data.resp.avs, aes(x=within_x, y=pct_err)) +
        geom_point(aes(color=factor(Time)), alpha=0.35, size=2.) +
        stat_smooth(method="loess", se=FALSE, aes(color=factor(Time)), span=3, size=1.5) +
        xlab("P(dots within gaze)") +
        ylab("Percent error") +
        #xlim(0,0.75) +
           scale_color_discrete(name="Time") +
        theme_light() + 
        paper_theme_3 +
         scale_x_log10()


data.resp.avs$seen_shown_diff <- data.resp.avs$within_x_tot - data.resp.avs$Dots_Shown
data.resp.avs$abs_seen_shown_diff <- abs(data.resp.avs$seen_shown_diff)
data.resp.avs$seen_shown_rat <- (data.resp.avs$within_x_tot - data.resp.avs$Dots_Shown)/data.resp.avs$Dots_Shown
data.resp.avs$abs_seen_shown_rat <- abs(data.resp.avs$seen_shown_rat)

p.5 <- ggplot(data.resp.avs, aes(x=abs_seen_shown_diff, y=abs_err)) +
      #  geom_point(aes(color=factor(Time)), alpha=0.35, size=2.) +

        stat_smooth(method="loess", se=FALSE, aes(color=factor(Time)), span=3, size=1.5) +
          stat_summary_bin(aes( color=factor(Time)), alpha=0.35, size=1., fun.data="mean_cl_boot", bins=7) +

        xlab("Abs(Seen - Shown)") +
        ylab("Absolute error") +
        coord_cartesian(ylim=c(0,45)) +
  
           scale_color_discrete(name="Time") +
        theme_light() +    paper_theme_3 


p.5.1 <- ggplot(data.resp.avs, aes(x=seen_shown_diff, y=err)) +
      #  geom_point(aes(color=factor(Time)), alpha=0.35, size=2.) +

        stat_smooth(method="loess", se=FALSE, aes(color=factor(Time)), span=3, size=1.5) +
          #stat_summary_bin(aes(color=factor(Time)), alpha=0.35, size=1., fun.data="mean_cl_boot", bins=9) +

        xlab("Seen - Shown") +
        ylab("Error") +
        coord_cartesian(ylim=c(-35,5)) +
           scale_color_discrete(name="Time") +
        theme_light() +  paper_theme_3 

p.5.2 <- ggplot(data.resp.avs, aes(x=seen_shown_diff, y=abs_pct_err)) +
      #  geom_point(aes(color=factor(Time)), alpha=0.35, size=2.) +

        stat_smooth(method="loess", se=FALSE, aes(color=factor(Time)), span=3, size=1.5) +
          stat_summary_bin(aes(color=factor(Time)), alpha=0.35, size=1., fun.data="mean_cl_boot", bins=7) +

        xlab("Seen - Shown") +
        ylab("Absolute percent error") +
           scale_color_discrete(name="Time") +
        theme_light() +  paper_theme_3 

p.5.3 <- ggplot(data.resp.avs, aes(x=seen_shown_diff, y=pct_err)) +
        stat_smooth(method="loess", se=FALSE, aes(color=factor(Time)), span=3, size=1.5) +
          stat_summary_bin(aes(color=factor(Time)), alpha=0.35, size=1., fun.data="mean_cl_boot", bins=6) +

        xlab("Seen - Shown") +
        ylab("Percent error") +
           scale_color_discrete(name="Time") +
        theme_light() +  paper_theme_3 



p.6 <- ggplot(data.resp.avs, aes(x=abs_seen_shown_diff, y=abs_err)) +
        geom_point(aes(color=factor(Time)), alpha=0.35, size=2.) +

        stat_smooth(method="loess", se=FALSE, span=1, size=1.5) +
         # stat_summary_bin(aes( color=factor(Time)), alpha=0.35, size=1., fun.data="mean_cl_boot", bins=7) +

        xlab("Abs(Seen - Shown)") +
        ylab("Absolute error") +
        #xlim(0,0.75) +
           scale_color_discrete(name="Time") +
        theme_light() +    paper_theme_3 


p.6.1 <- ggplot(data.resp.avs, aes(x=Dots_Shown, y=seen_shown_diff, color=factor(Time))) +
        stat_smooth(method="loess", se=FALSE,  span=2, size=1.5) +
          stat_summary_bin(alpha=0.35, size=1., fun.data="mean_cl_boot", bins=6) +

        xlab("Dots shown") +
        ylab("Seen - Shown") +
        coord_cartesian(ylim=c(-35,5)) +
           scale_color_discrete(name="Time") +
        theme_light() +  paper_theme_3  + scale_x_continuous(limits=range(data.resp.avs$Dots_Shown))
  

p.3
p.3.1
p.3.2
p.4
p.5
p.5.1
p.5.2
p.5.3

p.6
p.6.1
#ggsave("figs/gaze_tot.png", width=5,height=5)


#p.1
#p.2
summary(lm(data=data.resp.avs, Dots_Counted ~ within_x_tot))

#summary(lm(data=data.resp.avs, Dots_Counted ~ seen_shown_diff * within_x_tot))


#cory bonn

```


```{r, fig.width=5, fig.height=5}


ggplot(data=data.resp.avs, aes(x=within_x_tot/pctArea, y=Dots_Counted)) +
           geom_point(size=0.5,alpha=0.5) +
            stat_smooth(method='loess', span=2) +
            #stat_summary_bin(bins=12, fun.data="mean_cl_boot", color="blue") + paper_theme_2 +
           ggtitle("Dots seen v. counted") + xlab("(dots seen) / (% area seen)") + ylab("Dots counted") +
            paper_theme_2
          #  xlim(0,200)

ggplot(data=data.resp.avs, aes(x=within_x_tot, y=Dots_Counted)) +
           geom_point(size=0.5,alpha=0.5) +
            stat_smooth(method='loess', span=5) +
            ggtitle("Dots seen v. counted") + xlab("Dots seen") + ylab("Dots counted") +
            paper_theme_2  

data.resp.avs$Time_Cond <- as.factor(round(data.resp.avs$Time,2))


ggplot(data=data.resp.avs, aes(x=Time_Cond, y=pctArea)) +
    geom_jitter(alpha=0.25, width=0.1, height=0.04) + 
    stat_summary(fun.data="mean_cl_boot", color="red") +
    xlab("Time") + ylab("Proportion of screen area seen") +
   # scale_x_log10()  +
    paper_theme_2

ggplot(data=data.resp.avs, aes(x=within_x_tot/(pctArea*1.42), y=within_x_tot, color=Time_Cond)) +

           geom_jitter(size=1.0,alpha=0.5, width=2, height=7) +
            geom_abline(alpha=0.9) +

            stat_smooth(method='loess', span=2, size=1.2, se=FALSE) +
            ggtitle("(Dots seen) / (% area) v. dots seen") + xlab("Dots seen / (% area seen)") + ylab("Dots seen") +
            paper_theme_2  #+
           # ylim(7,140) + xlim(7,140)
    
    
#ggplot(data=data.resp.avs, aes(x=))

view(dfSummary(data.resp.avs))

```

