

---
output:
  html_document: default
  pdf_document:
    fig_caption: yes
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.width=5, fig.height=5,fig.align = "center",cache=TRUE)
```



```{r, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE}
##libraries, globals
#library(plyr)
library(ggplot2)
library(reshape)
library(grid)
library(dplyr)
library(gridExtra)
library(lme4)

paper_theme <- theme(
  panel.grid.major = element_blank(), 
  panel.grid.minor = element_blank(), 
  panel.background = element_blank(),
  axis.title.x = element_text(size=18),
  axis.text.x=element_text(colour="black", 
                           size = 12), 
  axis.title.y = element_text(size = 18, vjust = 1),
  axis.text.y  = element_text(size = 12),
  axis.line.x = element_line(colour = "black"), 
  axis.line.y = element_line(colour = "black"),
  legend.text=element_text(size=16),
  strip.text=element_blank(),
          strip.background = element_blank())

paper_theme_2 <- theme_light() + theme(axis.title.x = element_text(size=18),
  axis.text.x=element_text(colour="black", 
                           size = 14), 
  axis.title.y = element_text(size = 18, vjust = 1),
  axis.text.y  = element_text(size = 14))
binomial_smooth <- function(...) {
  geom_smooth(method = "glm", method.args = list(family = "binomial"), ...)
}
```

```{r, include=FALSE}

data.resp.loc <- read.csv("data/discrimination_dot_gaze.csv", sep="\t")
data.tracker <- read.csv("data/discrimination_tracker_data.csv", sep="\t")
data.tracker$trial_id <- floor((data.tracker$trial_id - 1)/2)
data.resp.loc$trial_id <- data.resp.loc$trial_id - 1

length(unique(data.tracker$trial_id))

data.resp.loc <- data.resp.loc %>%
                filter(belowX >= 0)
trials <- (unique(data.resp.loc$trial_id))
data.tracker <- data.tracker %>%
                group_by(trial_id) %>%
                filter(trial_id %in% trials)


data.resp.loc$id <- seq.int(1, nrow(data.resp.loc))
data.resp.loc$Score <- as.numeric(data.resp.loc$Score) - 1



data.resp <- data.resp.loc %>%
            group_by(Trial, Time1, Time2, pid) %>%
            mutate(cond=paste(round(Time1),round(Time2),sep="_")) %>%
            top_n(n=1, wt=id)  %>%
            group_by(Dots_Shown1, Dots_Shown2) %>%
            mutate(ratio = (Dots_Shown1 - Dots_Shown2)/(Dots_Shown1**2 + Dots_Shown2**2) ** 0.5)  

data.resp$Dots_Counted <- data.resp$Dots_Counted - 1
head(data.resp)

data.resp.vary <- subset(data.resp, data.resp$Time1 != data.resp$Time2)


data.tracker <- data.tracker %>%
                  filter(ValidityLeft == 0 & ValidityRight == 0) %>%

                mutate(av_x = (GazePointXLeft +GazePointXRight)/2) %>%
                mutate(av_y = (GazePointYLeft +GazePointYRight)/2) %>%
                group_by(trial_id) %>%
                mutate(Time = round(max(TimeStamp)/100)/10)

data.tracker$id <- seq.int(1,nrow(data.tracker))

data.resp.old <- cbind(data.resp)
```





```{r, echo=FALSE, warning=FALSE, message=FALSE}
data.resp <- cbind(data.resp.old)


data.resp$cond <- plyr::mapvalues(data.resp$cond, from = c("0_0", "0_1", "1_0", "1_1"), to = c("Short_Short", "Short_Long", "Long_Short", "Long_Long"))
 

ggplot(data=data.resp, aes(x=ratio, Dots_Counted, color=cond)) +
        binomial_smooth(se=FALSE)

ggplot(data=data.resp, aes(x=cond, y= Dots_Counted)) +
       stat_summary(fun.data="mean_cl_boot")



ggplot(data=data.resp, aes(x=abs(ratio), Score, color=cond)) +
        binomial_smooth(se=FALSE)

ggplot(data=data.resp, aes(x=cond, y=Score)) +
         stat_summary(fun.data="mean_cl_boot")


#summary(glm(data=data.resp.vary, Dots_Counted ~ ratio + cond, family=binomial(link="probit")))


data.resp$Score <- as.numeric(as.character(data.resp$Score))
data.resp <- data.resp %>%
           group_by(Subject,cond) %>%
           mutate(Score = mean(Score)) %>%
           top_n(n=1, wt=id) 


ggplot(data=data.resp, aes(x=cond, y=Score)) +
          stat_summary(fun.data="mean_cl_boot") +
        paper_theme +
            xlab("")  + ylab("p(correct)")

ggsave("figs/disc_score.png")
ggsave("figs/disc_score.png")

#summary(glmer(data=data.resp.vary, Dots_Counted ~ ratio + cond + #(1|Subject), family=binomial(link="probit")))

#levels(factor(data.resp$cond))
#data.resp$cond <-factor(data.resp$cond, levels = levels(factor(data.resp$cond))[c(2,1,3)])

summary(glm(data=data.resp, Dots_Counted ~ ratio + Time1 + Time2,  family=binomial(link="probit")))

```


```{r, echo=FALSE, warning=FALSE, message=FALSE}


data.resp.avs <- data.resp.loc %>% 
                  filter(gazeDist > 0) %>%
                  group_by(trial_id, which_array) %>%
                  mutate(arr1 = (which_array==1)*1) %>%
                  mutate(arr2 = (which_array==2)*1) %>%
                  mutate(belowX1 = mean(belowX) * arr1) %>%
                  mutate(belowX2 = mean(belowX) * arr2)%>%
                  mutate(pathLength1 = mean(pathLength) * arr1) %>%
                  mutate(pathLength2 = mean(pathLength) * arr2)%>%
                  mutate(medFix1 = mean(medFix) * arr1) %>%
                  mutate(medFix2 = mean(medFix) * arr2) %>%
                  mutate(pctArea1 = mean(pctArea) * arr1) %>%
                  mutate(pctArea2 = mean(pctArea) * arr2) %>%
                  mutate(within_x1 =  1/(1 + exp(-0.5 *belowX))) %>%
                  mutate(within_x2 =   1/(1 + exp(-0.5 *belowX)))  %>%
                  #mutate(within_x1 =  2/(1 + exp(-3 - 4 *belowX)) - 1) %>%
                 # mutate(within_x2 =   (2/(1 + exp(-3 - 4*belowX)) - 1))  %>%
                  mutate(within_x1 = arr1* sum(within_x1)) %>%
                  mutate(within_x2 = arr2*sum(within_x2)) %>%
                  top_n(n=1, wt=id)%>%
                  group_by(pid, Trial, Time1, Time2) %>%
                  mutate(pctArea1 = max(pctArea1)) %>%
                  mutate(pctArea2 = max(pctArea2)) %>%
                  mutate(belowX1 = max(belowX1)) %>%
                  mutate(belowX2 = max(belowX2)) %>%
                  mutate(within_x1 = max(within_x1)) %>%
                  mutate(within_x2=max(within_x2)) %>%
                  mutate(pathLength1 = max(pathLength1)) %>%
                  mutate(pathLength2 = max(pathLength2))%>%
                  mutate(medFix1 = max(medFix1)) %>%
                  mutate(medFix2 = max(medFix2))%>%
                 top_n(n=1, wt=id) %>%
                mutate(within_x1_pct = within_x1 / Dots_Shown1) %>%
                mutate(within_x2_pct = within_x2 / Dots_Shown2) %>% 
                mutate(within_x_pct_ratio = (within_x1 - within_x2)/((within_x1**2 + within_x2**2)**0.5)) %>%
               mutate(cond=paste(round(Time1),round(Time2),sep="_")) 

data.resp.avs.subs <- data.resp.avs %>%
            
            filter((Trial_End >= 1523639984) & ((within_x1) >  0 & (within_x2 > 0))) %>%
            group_by(Trial_End) %>%
            mutate(within_x_diff = (within_x1 - within_x2)) %>%
            mutate(within_x_ratio = (within_x1 - within_x2)/(within_x1**2 + within_x2**2)**0.5) %>%
            mutate(within_x_log_diff = (log(within_x1) - log(within_x2)))  %>%
            mutate(abs_within_x_log_diff = abs(within_x_log_diff))  %>%
  
            mutate(log_Dots_Diff =  log(Dots_Shown1) - log(Dots_Shown2)) %>%
            mutate(Dots_Ratio = (Dots_Shown1 - Dots_Shown2)/(Dots_Shown1**2 + Dots_Shown2**2)**0.5) %>%
            mutate(Abs_Dots_Ratio = abs(Dots_Ratio))  %>%
            mutate(Dots_Counted = Dots_Counted - 1) %>%
            mutate(Score = Score - 1)


subs_cop <- cbind(data.resp.avs.subs)

f_get_weber <- function(whomst) {
  whomst <- whomst[1]
  df <- subset(subs_cop, as.numeric(as.character(subs_cop$pid)) == as.numeric(whomst))
  reg <- glm(data=df, I(1-Dots_Counted) ~ Dots_Ratio - 1, family=binomial(link="probit"))
  return(1/(coef(reg)["Dots_Ratio"]))
}



data.resp.avs.subs <- data.resp.avs.subs %>%
            group_by(pid) %>%
            mutate(weber = f_get_weber(pid)) %>%
            mutate(log_PL1=log(pathLength1+1)) %>%
            mutate(log_PL2=log(pathLength2 + 1)) %>%
            mutate(log_PL = log(pathLength2 * pathLength1 + 1)) %>%
            mutate(log_fix1 = log(medFix1 + 1)) %>%
            mutate(log_fix2 = log(medFix2 + 1)) %>%
            mutate(log_fix = log_fix1 + log_fix2) %>%
            rowwise() %>%
            mutate(pctArea= pctArea1 + pctArea2) %>%

            mutate(dens_norm1 = within_x1/pctArea1) %>%
            mutate(dens_norm2 = within_x2/pctArea2) %>%
            mutate(dens_norm = log(dens_norm1) - log(dens_norm2)) %>% 
            mutate(dens_norm_err =dens_norm * (1 * (dens_norm1 < dens_norm2) * (Dots_Shown1 > Dots_Shown2) + 1 * (dens_norm1 > dens_norm2)  * (Dots_Shown1 < Dots_Shown2))) %>% 

            mutate(acc_err = (within_x1 - within_x2) *  (1 * (within_x1 < within_x2) * (Dots_Shown1 > Dots_Shown2) + 1 *  (within_x1 > within_x2) * (Dots_Shown1 < Dots_Shown2) )) %>% 
            #mutate(dens_norm_abs_err = abs(dens_norm_err)) %>% 
            mutate(acc_err_bin  =  1 * (within_x1 < within_x2) * (Dots_Shown1 > Dots_Shown2) - 1 *  (within_x1 > within_x2) * (Dots_Shown1 < Dots_Shown2)) %>% 
            mutate(dens_norm_err_bin  =  1 * (dens_norm1 < dens_norm2) * (Dots_Shown1 > Dots_Shown2) - 1 *  (dens_norm1 > dens_norm2) * (Dots_Shown1 < Dots_Shown2)) %>% 

            ungroup
  

```

```{r, fig.width=7, fig.height=5}


  

#SANITY CHECK
ggplot(data=data.resp.avs.subs, aes(x=Dots_Shown1, y=within_x1)) +
     geom_point() + 
      geom_abline() +
      #stat_summary_bin()+
      stat_smooth(method="loess") +

      facet_wrap(~cond) +
      paper_theme_2 



ggplot(data=data.resp.avs.subs, aes(x=abs_within_x_log_diff, y=Score)) +
        binomial_smooth(se=TRUE) +
          geom_hline(yintercept=0.5) +
        geom_vline(xintercept=0.0)+
        ylab("Score") +
        xlab("Absolute seen ratio") +
        paper_theme


ggplot(data=data.resp.avs.subs, aes(x=within_x_log_diff, y=Dots_Counted, color=cond)) +
        binomial_smooth(se=TRUE) +
          geom_hline(yintercept=0.5) +
        geom_vline(xintercept=0.0)+
        ylab("Guess 2") +
        xlab("Seen ratio") +
        paper_theme_2 

#THIS IS COOL -- SHOWS THAT YOU CAN ACCOUNT FOR ERROR

ggplot(data=data.resp.avs.subs, aes(x=(within_x_ratio ), 
                                          y=Dots_Counted)) +
      geom_point() +
      paper_theme_2 +
     # facet_wrap(~cond)
       binomial_smooth(se=TRUE) 


#How well does 
ggplot(data=subset(data.resp.avs.subs, data.resp.avs.subs$dens_norm_err != 0), 
        aes(x=dens_norm_err, y=Dots_Counted, color="Density")) +
#ggplot(data=data.resp.avs.subs, aes(x=dens_norm_err, y=Dots_Counted, color="Density")) +
             stat_summary_bin(bins=4) +
            binomial_smooth() +
          #  binomial_smooth(aes(x=acc_err, y=Dots_Counted, color="Accumulator"))  +
            paper_theme_2


ggplot(data=subset(data.resp.avs.subs, data.resp.avs.subs$dens_norm_err != 0), 
        aes(x=dens_norm_err)) +
      geom_histogram(bins=10,aes(fill=factor(Dots_Counted))) +
      paper_theme_2 +
      facet_wrap(~cond, nrow=4) +
      geom_vline(xintercept=0)

ggplot(data=data.resp.avs.subs) + 
        stat_summary(aes(x=acc_err_bin, y=Dots_Counted))  
  
#ggplot(data=data.resp.avs.subs, aes(color=cond)) + 
ggplot(data=data.resp.avs.subs) + 
            stat_summary(aes(x=factor(dens_norm_err_bin), y=Dots_Counted), 
                           geom="bar", size=1., alpha=0.5)  +
          stat_summary(aes(x=factor(dens_norm_err_bin), y=Dots_Counted), 
                           geom="point", size=2.)  +
          stat_summary(aes(x=factor(dens_norm_err_bin), y=Dots_Counted), 
                         geom="errorbar", width=0.25, size=1.)  +
      scale_x_discrete(labels=c("See 2 > 1, falsely", "Correctly estimate", "See 1 > 2, falsely")) +
        xlab("") + ylab("P(Choose 2)")  +
        #facet_wrap(~cond) #+
        paper_theme_2


summary(glm(data=data.resp.avs.subs, within_x1_pct ~  log_PL1))

summary(glm(data=data.resp.avs.subs, within_x2_pct ~ Dots_Shown2 * log_fix2))

summary(glm(data=data.resp.avs.subs, Score ~ pctArea + Abs_Dots_Ratio, family=binomial(link="probit")))

```




```{r}



subs <- data.resp.avs.subs %>%
        #group_by(pid, cond) %>%
        group_by(pid) %>%

        #mutate(weber = f_get_weber(pid)) %>%
        mutate(Score=mean(Score)) %>%
        mutate(pathLength1=mean(pathLength1)) %>%
        mutate(pathLength2=mean(pathLength2)) %>%
        mutate(medFix1=mean(medFix1)) %>%
        mutate(medFix2=mean(medFix2)) %>%
        mutate(log_PL1=log(pathLength1+.01)) %>%
        mutate(log_PL2=log(pathLength2+.01)) %>%
        mutate(log_PL = log(pathLength2 + pathLength1)) %>%
        mutate(log_fix1 = log(medFix1 + 1)) %>%
        mutate(log_fix2 = log(medFix2 + 1)) %>%
        mutate(log_fix = log_fix1 + log_fix2)  %>%
        mutate(pctArea1 = mean(pctArea1)) %>%
        mutate(pctArea2 = mean(pctArea2)) %>%

        top_n(n=1,wt=id)



#ggplot(subs, aes(x=log_PL, y=weber, group=cond, color=cond)) +
ggplot(subs, aes(x=pctArea, y=Score)) +
#ggplot(data.resp.avs.subs, aes(x=abs((log_PL1 + log_PL2) - (log(Dots_Shown1) + log(Dots_Shown2))), y=weber)) +
        geom_point() + 
      #binomial_smooth() + 

        #stat_summary_bin(fun.data="mean_cl_boot", bins=9) +
       # stat_summary(fun.data="mean_cl_boot") +
      stat_smooth(method="lm")  +
      #ylim(0,1) +
      #coord_cartesian(ylim=c(0.1,0.3)) +
    # facet_wrap(~cond, scales="free") +
      paper_theme_2

#ggplot(data.resp.avs.subs, aes(x=log_PL, y=weber, group=cond, color=cond)) +
ggplot(subs, aes(x=log_fix, y=weber)) +
        geom_point() +
     # stat_summary_bin(fun.data="mean_cl_boot", bins=9) +
      stat_smooth(method="lm")  +
      #ylim(0,1) +
      #coord_cartesian(ylim=c(0.1,0.3)) +
      facet_wrap(~cond) +
      paper_theme_2 +
      xlab("Average fixation time")





summary(glm(data=subs, Score ~ log_PL, family=binomial(link="probit")))
        

```
